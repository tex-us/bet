<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TEXBet - Premier League</title>
<script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
<style>
body { background-color: #0d0d0d; color: #f2f2f2; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; margin: 0; padding: 0; }
header { background-color: #1a1a1a; padding: 20px; text-align: center; }
header h1 { color: #ff3b3b; font-size: 28px; margin: 0; }

.container { width: 90%; max-width: 1200px; margin: 20px auto; }

table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
thead { background-color: #1a1a1a; border-bottom: 2px solid #ff3b3b; }
th, td { text-align: left; padding: 12px; border-bottom: 1px solid #333; }
th { font-weight: bold; color: #ff3b3b; }
tr:hover { background-color: #1f1f1f; }

button.bet-btn { background-color: #ff3b3b; color: #0d0d0d; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
button.bet-btn:hover { background-color: #ff6666; }

.winner { background-color: #228B22 !important; }
#status { text-align: center; margin: 15px 0; font-size: 16px; }
input.amount { width: 60px; padding: 3px; border-radius: 3px; border: 1px solid #555; background-color: #1a1a1a; color: #f2f2f2; }
</style>
</head>
<body>

<header>
  <h1>TEXBet - Premier League</h1>
</header>

<div class="container">
  <div style="text-align:center; margin-bottom:15px;">
    <button id="connectWallet">Connect Wallet</button>
    <p id="status">Wallet not connected</p>
  </div>

  <table id="matchesTable">
    <thead>
      <tr>
        <th>Time</th>
        <th>Match</th>
        <th>Pool (MATIC)</th>
        <th>Your Bet (MATIC)</th>
        <th>Outcome</th>
        <th>Amount</th>
        <th>Action</th>
        <th>Winner</th>
        <th>Payout</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div style="text-align:center; margin-bottom:30px;">
    <button id="simulateResults">Simulate Results & Payouts</button>
  </div>
</div>

<script>
const backendWallet = "0xdBcb6D0DC81d9b44652a86Df548b72283DE5396C"; 
let web3, userAccount;
const betsKey = "texBetPoolBets";
const payoutsKey = "texBetPoolPayouts";
let matches = [];
let results = {}; // match => outcome
let payouts = {}; // wallet => total payout

// Connect wallet
document.getElementById("connectWallet").onclick = async () => {
  if(window.ethereum) {
    web3 = new Web3(window.ethereum);
    try {
      await window.ethereum.request({ method: 'eth_requestAccounts' });
      const accounts = await web3.eth.getAccounts();
      userAccount = accounts[0];
      document.getElementById('status').innerText = "Connected: " + userAccount;
      renderMatches();
    } catch(err) { document.getElementById('status').innerText = "Connection failed: " + err.message; }
  } else { alert("Install MetaMask to use TEXBet!"); }
};

// Fetch Premier League matches
async function fetchMatches() {
  const leagueId = "4328"; // Premier League
  try {
    const res = await fetch(`https://www.thesportsdb.com/api/v1/json/3/eventsnextleague.php?id=${leagueId}`);
    const data = await res.json();
    matches = data.events ? data.events.map(ev => ({
      time: ev.strTime,
      match: `${ev.strHomeTeam} vs ${ev.strAwayTeam}`
    })) : [];
    renderMatches();
  } catch(err) {
    console.error("Failed to fetch matches:", err);
    alert("Could not load matches. Check console.");
  }
}

// Render table
function renderMatches() {
  const tbody = document.querySelector("#matchesTable tbody");
  tbody.innerHTML = "";
  const bets = JSON.parse(localStorage.getItem(betsKey)) || [];
  payouts = JSON.parse(localStorage.getItem(payoutsKey)) || {};

  matches.forEach(m => {
    const poolAmount = bets.filter(b => b.match===m.match).reduce((sum,b)=>sum+parseFloat(b.amount),0).toFixed(2);
    const userBet = bets.filter(b => b.wallet===userAccount && b.match===m.match).reduce((sum,b)=>sum+parseFloat(b.amount),0).toFixed(2);
    const winnerText = results[m.match] || "";

    const row = document.createElement("tr");
    if(results[m.match]) {
      const userWins = bets.filter(b => b.wallet===userAccount && b.match===m.match && b.outcome===results[m.match]);
      if(userWins.length) row.classList.add("winner");
    }

    const payoutAmount = bets.filter(b => b.wallet===userAccount && b.match===m.match && b.outcome===results[m.match])
                             .reduce((sum,b)=>sum + parseFloat(b.amount)*2,0).toFixed(2);

    row.dataset.match = m.match;
    row.innerHTML = `
      <td>${m.time}</td>
      <td>${m.match}</td>
      <td>${poolAmount}</td>
      <td>${userBet || 0}</td>
      <td>
        <select class="outcomeSelect">
          <option value="Team1Win">Team1 Win</option>
          <option value="Team2Win">Team2 Win</option>
          <option value="Draw">Draw</option>
        </select>
      </td>
      <td><input class="amount" type="number" min="0.01" step="0.01" value="0.01"></td>
      <td><button class="bet-btn">Bet</button></td>
      <td>${winnerText}</td>
      <td>${payoutAmount}</td>
    `;
    tbody.appendChild(row);
  });
}

// Bet button
document.querySelector("#matchesTable tbody").addEventListener("click", async (e) => {
  if(e.target && e.target.classList.contains("bet-btn")) {
    const row = e.target.closest("tr");
    const match = row.dataset.match;
    const outcome = row.querySelector(".outcomeSelect").value;
    const amountInput = row.querySelector(".amount");
    let amount = parseFloat(amountInput.value);
    if(!userAccount) { alert("Connect wallet first!"); return; }
    if(amount<=0) { alert("Enter a valid amount"); return; }

    try {
      const tx = await web3.eth.sendTransaction({
        from: userAccount,
        to: backendWallet,
        value: web3.utils.toWei(amount.toString(), "ether")
      });

      const bet = { wallet: userAccount, match, outcome, amount, txHash: tx.transactionHash };
      saveBet(bet);
      renderMatches();
      document.getElementById('status').innerText = `Bet placed: ${tx.transactionHash}`;
    } catch(err) { document.getElementById('status').innerText = "Tx failed: "+err.message; }
  }
});

// Save bet
function saveBet(bet) {
  const allBets = JSON.parse(localStorage.getItem(betsKey)) || [];
  allBets.push(bet);
  localStorage.setItem(betsKey, JSON.stringify(allBets));
}

// Simulate results & payouts
document.getElementById("simulateResults").onclick = () => {
  const outcomes = ["Team1Win","Team2Win","Draw"];
  matches.forEach(m => {
    results[m.match] = outcomes[Math.floor(Math.random()*outcomes.length)];
  });

  const bets = JSON.parse(localStorage.getItem(betsKey)) || [];
  payouts = {};

  matches.forEach(m => {
    const winners = bets.filter(b => b.match===m.match && b.outcome===results[m.match]);
    winners.forEach(w => {
      if(!payouts[w.wallet]) payouts[w.wallet] = 0;
      payouts[w.wallet] += parseFloat(w.amount)*2; // 2x payout
    });
  });

  localStorage.setItem(payoutsKey, JSON.stringify(payouts));
  console.log("Simulation results:", results);
  console.log("Payouts:", payouts);
  alert("Simulation complete! Payouts updated (see console).");
  renderMatches();
}

// Auto-refresh pool every 10s
setInterval(renderMatches, 10000);

// Initial fetch
fetchMatches();
</script>
</body>
</html>
